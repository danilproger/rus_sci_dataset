ВОССТАНОВЛЕНИЕ ТРЕХМЕРНОЙ ГЕОМЕТРИИ СОСУДОВ   ПО ДАННЫМ КОМПЬЮТЕРНОЙ ТОМОГРАФИИ 

Рассматриваются алгоритмы построения триангуляции внутренней поверхности коронарных артерий сердца  по данным компьютерной томографии. Точное определение геометрии сосудов необходимо для построения  гидродинамической модели кровоснабжения сердца и расчета параметров кровотока с помощью уравнений  Навье – Стокса. Для восстановления трехмерной геометрии применяется комбинация двух основных методов:  трехмерного алгоритма роста области из семени и ячеечного метода, использующего разбиение пространства  на тетраэдры. При этом используется тетраэдрическая сеть, предложенная в работах S. Chan, E. Purisima  (1998) и V. Skala (2000), в которой тетраэдры строятся в кубической решетке на общих гранях смежных кубов.  Эта сеть строится не на всем пространстве, а только в окрестности границы множества вокселей, вычисленного на первом этапе как результат применения трехмерного алгоритма роста области.  

 Ишемическая болезнь сердца является одним из самых распространенных заболеваний. Ее основной причиной является нарушение кровоснабжения сердечных мышц, связанное, как правило, с сужением коронарных артерий стеноз. В настоящее время имеются достаточно эффективные методы ее лечения, главным из которых является установка расширителей сосудов стентов. Для этого в коронарную артерию вводится катетер. Перед проведением подобной операции необходимо вначале убедиться в ее необходимости. Одним из основных критериев является так называемая величина FFR fraction flow reserve, показывающая, насколько уменьшается кровоток в месте сужения артерии. FFR определяется как отношение давления крови в точках до и после сужения. В медицине используется так называемый золотой стандарт измерения FFR, использующий инвазивный метод введение катетера с датчиком давления в артерию. Несмотря на то, что в настоящее время эта процедура хорошо отработана и может быть совмещена с установкой стента, желательно все-таки иметь возможность определить FFR каким-либо неинвазивным методом, например, используя данные компьютерной томографии области сердца. Это поможет избежать введения катетера в коронарную артерию в случаях, когда нет необходимости в установке стента. При исследовании кровеносных сосудов с помощью компьютерной томографии в кровь пациента через вену вводится контрастное вещество, резко увеличивающее степень поглощения рентгеновских лучей кровью. Томографические срезы, полученные компьютерным томографом, представляют собой матрицы размером 512 512, содержащие двухбайтовые целые числа со знаком. Их величины обозначаются через HU housfield units, они отражают степень поглощения рентгеновских лучей тканью пациента в данной точке среза. Величина HU воздуха равна 1 024, воды 0, крови без контрастного вещества около 4050. При введении контрастного вещества в кровь ее HU резко возрастает до нескольких сотен, и кровеносные сосуды становятся хорошо различимыми на фоне окружающих тканей. Данная работа является частью проекта создания компьютерной модели кровоснабжения сердца для конкретного пациента. Основная идея состоит в том, чтобы определить всевозможные параметры кровотока методами гидродинамики, применяя численные методы решения уравнений течения жидкости уравнения Навье Стокса, уравнение состояния и др. Эти численные методы предполагают построение геометрии расчетной области в виде задания ее триангуляции, затем вычисление расчетной сетки и численное решение по этой сетке дифференциальных уравнений в частных производных. Предполагается использовать систему FlowVision 1 2, успешно применяемую в расчетах, необходимых для кораблей, турбин, летательных аппаратов и т. п. Для ее применения в области медицинской диагностики при изучении системы кровообращения требуется на первом шаге точно воссоздать трехмерную геометрию кровеносных сосудов, в нашем случае аорты и коронарных артерий. В данной работе рассматривается именно эта задача. Томографические срезы представляют собой последовательность параллельных сечений тела пациента. Современный томограф позволяет за очень короткое время около 0,35 с получить серию срезов с очень высоким разрешением обычно сканируется область размером 16 см по оси вертикальной оси тела пациента с шагом 0,25 мм по вертикали, при этом горизонтальные размеры пикселя по осям и равны 0,5 мм. Компьютерный томограф практически мгновенно выдает серию из 640 срезов в области сердца. Эти срезы определяют функцию рентгеновской плотности ткани человеческого тела в трехмерном пространстве, в промежутках между срезами она вычисляется с помощью интерполяции. Стандарт DICOM digital imaging and communication in medicine определяет следующие направления координатных осей ось направлена от правой части тела пациента к левой Right Left, ось от передней стороны тела к задней Anterior Posterior, ось от ног к голове Feet Head. Задачу трехмерной реконструкции в самом простом случае можно сформулировать как построение триангуляции поверхности, заданной уравнением, где, функция плотности, пороговое значение threshold. В зависимости от выбора значения мы восстанавливаем разные структуры человеческого тела например, при 200 получается поверхность не очень твердых костей, при 1 000 зубов, при 200 опухолей в легких и т. п. При восстановлении внутренней поверхности кровеносных сосудов в случае использования контрастного вещества применяется пороговое значение в пределах HU от 150 до 400. Отметим также, что практически всегда восстановление такой поверхности выполняется не во всем пространстве, а только в интересуемой области, в медицине для этого используется термин ROI region of interect или, реже, VOI volume of interest. ROI обычно задается либо наборами контуров на каждом срезе, либо наборами битовых маск чаще всего используются оба метода одновременно. Существует два основных класса алгоритмов трехмерной реконструкции. Первый класс состоит из так называемых ячеечных методов, среди них наиболее известен метод марширующих кубов 3, 1987. В таких методах пространство разбивается на многогранники маленького размера в несколько пикселей на томографических срезах, например, на маленькие кубики в методе марширующие кубы или тетраэдры в методах типа марширующие тетраэдры методы МТ5, MT6 и др.. Под словом тетраэдр всюду в этой статье подразумевается любая треугольная пирамида, не обязательно правильный тетраэдр. Значение функции, вычисляется в вершинах этих многогранников. Рассматриваются ребра каждого многогранника. Если в вершинах ребра функция принимает значения разных знаков, то при допущении, что в точках ребра функция меняется линейно, вычисляется точка на ребре, в которой функция принимает значение 0. Полученные точки на ребрах соединяются одним или несколькими треугольниками внутри рассматриваемого многогранника. Объединяя полученные таким образом точки и треугольники, получаем триангуляцию всей поверхности см. далее, рис. 4 для случая тетраэдрических ячеек. Второй класс алгоритмов состоит из так называемых методов роста области из семени seeded region grow, мы рассматриваем их трехмерные варианты. Алгоритм роста области из семени строит множество вокселей внутри интересуемой области, которая может задаваться пороговым значением функции, в трехмерном пространстве область состоит из вокселей, значения функции в которых не ниже порогового, а также какими-либо другими признаками. В интересуемой области выбирается начальный воксель семя, он добавляется к множеству . Затем программа в цикле добавляет к множеству воксели, соседние с уже содержащимся в и удовлетворяющие критерию принадлежности к области. В процессе работы алгоритм использует какую-либо динамическую структуру, содержащую воксели, которые уже были добавлены к множеству, но соседи которых еще не были рассмотрены. Алгоритм заканчивается, когда становится пустой. В качестве можно использовать очередь, стек, список, но наиболее удобной структурой такого рода является структура Deque double ended queue двусторонняя очередь, содержащаяся в стандартной библиотеке языка C stddeque. Вот запись трехмерного алгоритма роста области из семени на псевдокоде множество вокселей очередь вокселей deque 0 начальный воксель семя .добавить 0 .добавить в конец 0 цикл пока не пуста выполнять .начало .удалить начало цикл для каждого соседа вокселя выполнить если не принадлежит множеству и удовлетворяет критерию принадлежности к области, то .добавить .добавить в конец конец если конец цикла конец цикла В качестве соседей вокселя в трехмерном пространстве берутся либо 6 соседей, одна из координат которых отличается ровно на единицу от соответствующей координаты, либо 26 соседей, представляющих собой все воксели куба размером 3 3 с центром, отлич ные от . Метод роста области из семени имеет совсем простую программную реализацию. Но главным достоинством этого метода является то, что он вычисляет связную область, содержащую начальный воксель. Он хорошо подходит для построения множества вокселей внутри кровеносных сосудов, поскольку такое множество невозможно задать только на основе порогового значения. Например, костная ткань плотность которой варьируется в очень широких пределах может иметь такие же значения плотности HU, как и кровь при использовании контрастного вещества, поэтому ячеечными методами отделить кровеносную систему от костной ткани невозможно. Но алгоритм роста области добавляет к трехмерной модели лишь те воксели, которые связаны с начальным вокселем семенем. Если начальный воксель находится внутри кровеносного сосуда, то и все добавленные воксели будут находиться внутри кровеносной системы учитывая, что кровеносная система замкнута алгоритм роста не должен протекать в пространство вне сосудов. Таким образом, костная ткань автоматически исключается из трехмерной модели. После построения множества вокселей остается вычислить триангуляцию его поверхности. Эта процедура также несложная рассматриваются те грани внешних вокселей из множества, к которым не примыкают другие воксели из . Каждая такая прямоугольная грань разбивается диагональю на 2 треугольника, и получаем требуемую триангуляцию поверхности множества . Еще одно достоинство алгоритма роста области состоит в том, что несложно ограничить рост области, заполнив контуры на некоторых срезах и запустив алгоритм роста повторно . На рис. 1 изображены результаты восстановления области сердца, полученные трехмерным алгоритмом роста области. Левая модель получена ростом из начального вокселя, расположенного внутри аорты. В правой модели используется задание области интереса ROI, которая отделяет часть аорты и коронарные артерии от остальной части кровеносной системы правая модель представляет собой часть модели, изображенной слева. Но у алгоритма роста области из семени есть и недостатки. Первым из них является большее время работы, чем у ячеечных алгоритмов, поскольку рассматриваются все воксели трехмерной модели, которая строится, а их число может быть очень большим. В ячеечных алгоритмах можно выбирать размер шага т. е. размер многогранников, на которые разбивается пространство, но в алгоритме роста области шаг всегда минимально возможный он равен размеру одного вокселя. Кроме того, ячеечные алгоритмы добавляют к модели лишь треугольники, расположенные на поверхности модели, а алгоритм роста области проходит по всему ее объему. Однако для наших целей этот недостаток не столь существенен, поскольку в любом случае шаг нужно выбирать минимально возможным, чтобы достичь наилучшего разрешения, так как коронарные артерии могут иметь очень небольшой поперечный размер. К тому же современные компьютеры позволяют достичь очень высокой скорости, и вдобавок отсутствуют существенные ограничения на объем оперативной памяти. Отметим, что второй недостаток алгоритма роста области, увы, не позволяет напрямую его использовать при построении триангуляции для последующего гидродинамического расчета. Дело в том, что поверхность построенной модели получается негладкой, она составлена из поверхностей кубиков, представляющих собой воксели полученного множества рис. 2, 3. Если бы цель состояла только в том, чтобы получить изображение поверхности, то эта проблема была бы не столь существенна трехмерный алгоритм Фонга с использованием нормалей в вершинах триангуляции позволяет визуально сгладить изображаемую поверхность см. рис. 2. Но при гидродинамическом расчете поверхность нуждается в реальном, а не только визуальном сглаживании. Алгоритмы сглаживания из класса Subdivision Surface дробление поверхности, такие как алгоритм Лупа 4 или Кетмулла Кларка 5, также мало подходят для нашей цели, поскольку они, лишь сглаживая углы, в целом не меняют форму поверхности, к тому же в медицинской диагностике желательно избежать даже минимального изменения формы вычисляемой поверхности. Отметим, что ячеечные алгоритмы строят более гладкую поверхность, поскольку по строенные в них треугольники получаются приблизительно перпендикулярными вектору градиента функции плотности, в отличие от метода роста области, в котором плоскости треугольников параллельны координатным плоскостям. Решение проблемы состоит в последовательном применении двух алгоритмов. Сначала с помощью алгоритма роста области из семени вычисляется множество вокселей, составляющее трехмерную модель интересующего участка кровеносной системы . На втором этапе используется ячеечный алгоритм вычисления триангуляции, причем он применяется не ко всему пространству, а только к окрестности поверхности модели, вычисленной на первом этапе. Самым первым ячеечным алгоритмом построения триангуляции изоповерхности был метод марширующих кубов 3. Он неплох, если речь идет только об изображении трехмерного объекта. Однако быстро выяснился его серьезный недостаток в некоторых случаях вершины триангуляции на ребрах куба можно соединить треугольниками разными способами. При несогласованном выборе треугольников внутри смежных кубов в построенной триангуляции сплошного объекта могут образоваться дыры. Всего с точностью до симметрии имеется 14 вариантов расположения вершин триангуляции на ребрах куба, неоднозначность возможна в 5 случаях. Вероятность этих ситуаций мала, и они почти не влияют на визуальное восприятие объекта, но если речь идет о точном воспроизведении топологии, то подобное недопустимо. Этого недостатка лишены ячеечные методы, в которых пространство разбивается на тетраэдры. С точностью до симметрии имеется лишь 2 варианта расположения вершин триангуляции на ребрах тетраэдра. В случае трех точек они соединяются одним треугольником, в случае четырех двумя рис. 4, других случаев не бывает. При использовании тетраэдрических ячеек возникает проблема как выбрать наилучшую тетраэдрическую сеть Дело в том, что разбить трехмерное пространство на правильные тетраэдры невозможно в отличие от плоскости, которая разбивается на правильные треугольники. Это означает, что априори самой лучшей тетраэдрической сети не существует. Обычно под качеством сети понимают средний аспект входящих в нее тетраэдров. Аспектом тетраэдра называется отношение радиусов описанной и вписанной сфер. Аспект правильного тетраэдра в точности равен 3, у любого тетраэдра, отличного от правильного, аспект стро го больше трех, так что аспект может служить мерой того, насколько тетраэдр отличается от правильного. Также желательными свойствами тетраэдрической сети являются равенство входящих в нее тетраэдров, инвариантность сети относительно сдвигов в трех независимых направлениях, удобство программирования и т. п. Самым простым методом построения тетраэдрической сети является разбиение пространства сначала на кубы, а затем разбиение каждого куба на тетраэдры. Не добавляя дополнительных вершин, куб можно разбить на тетраэдры 6 способами. В методе MT5 см. 6 куб разбивается на 5 тетраэдров, из которых один правильный с объемом, он образован скрещивающимися диагоналями граней куба остальные 4 тетраэдра имеют объем, каждый из них образован тремя перпендикулярными ребрами куба, выходящими из одной вершины. Это разбиение изображено слева на рис. 5. В методе MT6 см. 7 куб разбивается на 6 равных тетраэдров см. рис. 5, в центре. Сеть MT6 удобна тем, что она инвариантна относительно сдвигов на вектор любого ребра куба. Однако для нашей цели лучше всего подходит сеть, предложенная в работе S. L. Chan, E. O. Purisima 8 она стала широко известна также и благодаря статье V. Skala 9, в литературе ее часто называют сетью Скала. Тетраэдры этой сети изображены на рис. 5, справа, они строятся на границах смежных кубов кубической решетки. В сети Скала все тетраэдры равны между собой это тетраэдры Кокстера, сеть инвариантна при отражениях пространства относительно любых граней тетраэдров. Сеть Скала имеет наилучший аспект 3.162 среди всех известных на данный момент тетраэдрических сетей. Для сравнения аспект сети MT6 равен 4.182, средний аспект сети MT5 равен 3.878., Помимо остальных прекрасных свойств сети Chan Purisima Skala равенство входящих в нее тетраэдров, наилучший аспект среди всех известных сетей, инвариантность относительно сдвигов и отражений, она обладает свойством, крайне ценным для нашей задачи в ней тетраэдры строятся на гранях смежных кубов кубической решетки. Справа на рис. 5 изображены 4 тетраэдра, построенные на общей грани двух смежных кубов, расположенных горизонтально, аналогично строятся тетраэдры на общей грани соседних кубов, расположенных вертикально и во всех трех независимых направлениях. Вершины построенных тетраэдров находятся в вершинах исходной кубической решетки, а также в центрах кубов. Если размер ребра куба равен 1, то длины ребер тетраэдров равны 1 два ребра, совпадающие с ребрами куба и 32 0,866 остальные 4 ребра, равные половине большой диагонали куба. Если каждый куб решетки представляет воксель в пространстве, то построенная на этих кубах тетраэдрическая сеть Скала позволяет достичь субпиксельной точности, которая необходима для точного восстановления геометрии кровеносных сосудов. Ключевой момент состоит в том, что тетраэдрическая сеть строится не во всем пространстве, а только в окрестности границы трехмерной воксельной модели, полученной алгоритмом роста области из семени. Благодаря этому при последующем применении ячеечного метода трехмерного восстановления мы не добавляем нежелательных объектов к модели, а лишь уточняем форму ее поверхности. Точный алгоритм построения уточняющей тетраэдрической сети следующий. Обозначим через исходную модель, полученную трехмерным алгоритмом роста области из семени, она состоит из кубических вокселей. Каждый воксель пространства это куб с 8 вершинами. Какие-то вершины вокселей из могут лежать на поверхности модели, какие-то нет. Построим множество вокселей следующим образом произвольный воксель трехмерного пространства добавляется к, если хотя бы одна из его вершин лежит на поверхности модели . Таким образом, множество будет содержать как некоторые воксели из модели, так и некоторые воксели, не входящие в, но касающиеся ее границы. После определения множества вокселей строится уточняющая тетраэдрическая сеть для любых двух соседних вокселей из, имеющих общую грань, строятся 4 тетраэдра сети см. рис. 5, справа. Схематично процесс построения сети изображен на рис. 6 в двумерной проекции трехмерный рисунок получился бы слишком громоздким. На рис. 6 темными квадратами показаны воксели исходной модели множество, светлыми воксели из построенного множества, не принадлежащие, но имеющие вершину на границе . Каждые 2 соседних вокселя из множества определяют 4 тетраэдра, которые строятся на их общей грани, проекции этих тетраэдров нарисованы тонкими линиями. После построения уточняющей тетраэдрической сети запускается алгоритм трехмерного восстановления изоповерхности ячеечного типа. Результат применения алгоритма для модели тора показан на рис. 7. В правой части рис. 7 специально используется плоский режим закрашивания треугольников, чтобы они были лучше видны на изображении. Если применить алгоритм Фонга, использующий нормали в вершинах триангуляции для сглаживания изображения, то результат получается визуально совершенно гладким. На рис. 8 уточненная модель изображена слева как проволочный каркас Wireframe, справа используется алгоритм Фонга. На рис. 9. показан результат применения уточняющего алгоритма для компьютерной модели кровеносного сосуда. Отметим, что толщина сосуда в этом примере минимальна 34 вокселя, а исходная воксельная модель имеет форму, далекую от цилиндрической, однако уточненная триангуляция получается достаточно гладкой. На рис. 10 и 11 показан результат применения алгоритма к реальным данным. Слева изображена воксельная модель, в центре и справа триангуляция, полученная уточняющим алгоритмом используется плоское и гладкое закрашивание граней. Рисунок 11 крупно показывает небольшой фрагмент модели, представленной на рис. 10. Все алгоритмы, описанные в данной работе, реализованы на языке C с использованием библиотеки классов Qt и системы разработки приложений QtCreator. Для получения изображений использовалась библиотека трехмерной графики OpenGL. Был реализован как трехмерный алгоритм роста области из семени, так и ячеечный алгоритм восстановления изоповерхности, использующий тетраэдрическую сеть Chan Purisima Skala. Последний алгоритм реализован в двух вариантах классический вариант строит сеть во всем пространстве, в варианте уточнения границы сеть строится только в окрестности границы воксельной модели, как описано выше. Отметим, что алгоритм уточнения границы воксельной модели работает чрезвычайно быстро, поскольку он проходит не по всему пространству, а только по границе модели, до этого вычисленной алгоритмом роста области. Тетраэдры сети имеют размеры, не превышающие размера вокселя, и строятся очень естественно по вокселям исходной модели. Это позволяет достичь необходимой гладкости и субпиксельной точности результирующей модели. Причем в модель не вносятся никакие искажения формы при сглаживании, неизбежные, к примеру, в методах Лупа или Кетмулла Кларка 4 5, поскольку все вычисления используют только исходную функцию плотности объекта в трехмерном пространстве, полученную как результат томографического обследования пациента. Таким образом, комбинация этих двух алгоритмов позволяет точно и эффективно воссоздать сглаженную трехмерную модель сосудов кровеносной системы, необходимую для программ гидродинамических расчетов. 