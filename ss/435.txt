ИНТЕРАКТИВНОЕ БАЙЕСОВСКОЕ МАТИРОВАНИЕ ИЗОБРАЖЕНИЙ 

Цифровое матирование – это процесс извлечения объекта переднего плана из произвольного естественного изображения. Полученный слой с объектом может использоваться для фотомонтажа либо ретуши исходного изображения. В отличие от задачи сегментации изображений для нечетких границ объектов (волосы, перья и т.д.) требуется вычислить корректный канал прозрачности. Основными недостатками существующих подходов являются низкая точность и серьезные трудности, с которыми сталкивается пользователь, пытаясь улучшить результат, так как многие алгоритмы не являются интерактивными и требуют полного пересчета результата. В статье описан разработанный авторами алгоритм интерактивного матирования на основе байесовского подхода и представлена его программная реализация. Постановка задачи формализуется с использованием теоретико-вероятностного математического аппарата применительно к цветам пикселей и значениям прозрачности. Предложенный подход повышает точность результата, кроме того, путем использования иерархической обработки удается увеличить скорость работы на больших изображениях. Улучшения подтверждены численными оценками и визуальным сравнением. Описан и интерактивный вариант алгоритма, позволяющий пользователю улучшать результат, не прибегая к ручному редактированию изображения..

 Матированием называется отделение на изображении объекта переднего плана от фона. При этом для каждого пикселя нужно получить цвет и значение прозрачности. Затем извлеченный объект можно наложить на другой фон или применить к нему какую-либо обработку, например цветокоррекцию. Предположим, что исходное изображение C является смесью изображений F и B с каналом прозрачности. Задача состоит в получении, F и иногда B по заданному исходному изображению C с использованием какого-либо дополнительного ввода со стороны пользователя. Алгоритмы матирования получают на вход исходное изображение с разметкой. Обычно используется тернарная разметка заданная пользователем сегментация изображения на три региона объект переднего плана, фон и неизвестная область. Первые две дают некую информацию об объекте, который необходимо извлечь, а последняя определяет регион применения алгоритма. Результатом алгоритма являются слой переднего плана с известным цветом и прозрачностью для каждого пикселя, а также слой фона. При смешивании эти слои должны в точности давать исходное изображение. Следует заметить, что если два из трех этих значений известны, то третье может быть однозначно посчитано. Задача является сильно недоопределенной, так как для каждого цвета исходного изображения C существует бесконечное число комбинаций цветов объекта и фона. Чтобы сделать ее решаемой, требуется некоторая регуляризация. Байесовский подход Данный подход является одним из основных методов регуляризации. Применительно к задаче матирования он был впервые предложен в статье 1. Пиксели обрабатываются начиная с границ регионов объектафона, шаг за шагом сужая неизвестную область. Пиксели, обработанные на предыдущих шагах, также учитываются в выборках объекта и фона в дополнение к пикселям из известных областей. В качестве цветовой модели используется множество ориентированных гауссиан. Алгоритм использует схему Байеса для максимизации правдоподобия значений F, B и. Рассмотрим байесово матирование более подробно. Взаимное расположение цветов F, B и и соответствующих распределений проиллюстрированы на рисунке 1. В случае нескольких пар кластеров объекта фона оптимальные F, B и вычисляются для каждой пары и выбирается пара, дающая наибольшую величину правдоподобия L. Для максимизации неквадратичной функции используется итеративная процедура, поочередно принимающая и F, B за константы, что дает две квадратичные задачи. В качестве начального приближения для используется среднее значение по окрестности обрабатываемого пикселя. Для константной выводится следующая линейная относительно F и B система линейных алгебраических уравнений размером 6 на 6 Для константных F и B результат для является проекцией C на отрезок FB. Вычисление F, B и поочередным применением формул и продолжается до наступления сходимости. Гладкость канала прозрачности Байесов алгоритм матирования очень чувствителен к перекрытиям цветовых моделей объекта и фона. В исходном алгоритме это делает вычисление нестабильным и часто приводит к существенному шуму в получаемом канале прозрачности. Использование простого размытия или медианного фильтра может улучшить канал прозрачности, но при этом маленькие детали объекта могут быть потеряны. Поэтому авторы предлагают в байесову схему добавить член, отвечающий за гладкость канала прозрачности 2. Моделируем гладкость одномерным гауссианом с математическим ожиданием, равным среднему значению прозрачности по ранее обработанным пикселям, то есть тем же значением, что используется в качестве начального приближения для при решении системы . Формула заменяет формулу в процессе минимизации. Определить можно несколькими способами. Во-первых, используя значение, настраиваемое пользователем. В-третьих, можно применять двухпроходное байесово матирование, используя значения правдоподобия, вычисленные на первом проходе, для оценки на втором проходе. Значение 0,2 для подбиралось эмпирически. Это же значение используется в качестве изначального приближения для в уравнении . Использование члена, отвечающего за гладкость, почти не влияет на время работы алгоритма. Пример работы алгоритма с изображением приведен на рисунке 2. Иерархический подход Другим улучшением является иерархическое байесово матирование. Главной задачей этого улучшения было уменьшение времени работы алгоритма без потери качества матирования. Самым простым способом было бы применить байесово матирование к уменьшенному изображению, после чего увеличить изображение до исходного разрешения и выполнить байесово матирование еще раз, но со значительно меньшим радиусом выборки. Однако есть более эффективный способ применяя иерархический подход Closed Form Solution 3 к результату байесова матирования, можно вычислить коэффициенты линейного приближения прозрачности значениями цвета для уменьшенного изображения и использовать их, чтобы увеличить канал прозрачности до исходного разрешения. Это позволяет полностью избавиться от второго прохода алгоритма, так как получающийся канал прозрачности обычно достаточно точен. Для восстановления F и B каналов можно также предположить, что их RGB-каналы являются линейными комбинациями каналов исходного изображения C . Получаем уменьшенное изображение билинейной интерполяцией. При вычислении уменьшенной разметки пиксель считается принадлежащим объектуфону, если все соответствующие пиксели разметки исходного разрешения принадлежат объектуфону, в противном случае пиксель помечается как неизвестный. Значения параметров байесова матирования, таких как сигма, используемая для пространственного взвешивания выборки, тоже уменьшаются. Байесово матирование выполняется на уменьшенном изображенииразметке и выдает изображения, F и B. Эти изображения нужно увеличить до исходного разрешения. Для канала прозрачности и для каждого канала изображений F и B применим следующую процедуру. 1. Вычислить коэффициенты a и b для каждого пикселя уменьшенного изображения с помощью метода наименьших квадратов по окну 3 на 3, как в уравнении . 2. Увеличить карты коэффициентов, используя билинейную интерполяцию. 3. Можно заметить, что применение уравнения к уменьшенному изображению размывает альфа-канал. Чтобы предотвратить это, на шаге 1 приравняем значение альфы в обрабатываемом пикселе правой части уравнения. Применение байесова матирования к изображениям меньшего разрешения дает нелинейное ускорение, поскольку уменьшается не только число обрабатываемых пикселей, но и области поиска образцов цветов F, B. При небольших коэффициентах масштабирования качество матирования практически не изменяется. Интерактивное матирование изображений Выше был описан алгоритм вычисления канала прозрачности на основе исходного изображения и тернарной разметки. Теперь рассмотрим процедуру создания такой разметки пользователем 4. Вначале пользователю предлагается построить жесткую разметку, используя мазки кистями объекта и фона. Для этого используется алгоритм GrowCut. Целью данного шага является построение точной сегментации четких контуров и приближенной сегментации мягких областей. Затем генерируется переходная область тернарной разметки морфологическим сжатием областей объекта и фона. Радиус сжатия выбирается пользователем и может быть изменен в реальном времени. Задача пользователя настроить ширину переходной области так, чтобы были покрыты все четкие края с учетом их средней размытости. Для нечетких и полупрозрачных областей, которые невозможно обработать бинарной сегментацией и морфологией, предлагается инструмент расширения разметки. Он позволяет быстро добавлять большие переходные области, соединенные с уже существующими. Инструмент работает следующим образом. 1. Пользователь рисует фрагмент границы нечеткой области внутри объекта или фона. 2. Концы границы соединяются с существующей переходной областью. Для поиска кратчайшего соединяющего пути в изображении используется алгоритм Дейкстры. 3. Концы найденных путей соединяются между собой, чтобы образовать замкнутую область. Для этого ищется путь от одного конца до другого внутри неизвестной области. 4. Полученная область, состоящая из пользовательской траектории, двух соединений и внутреннего соединения, помечается как переходная. Граница в первом шаге может быть получена одним из двух способов явным рисованием границы пользователем или указанием пользователем двух точек, которые затем соединяются с помощью алгоритма Дейкстры. Предложенный метод взаимодействия с пользователем является интуитивным и удобным для быстрого расширения существующей переходной области в зоны полупрозрачных элементов. Такой подход быстрее ручного рисования переходной области и в то же время дает возможность получать более точную область . После завершения редактирования разметки применяется алгоритм байесовского матирования со сглаживанием, описанный ранее. Пользователь может выбирать степень гладкости и коэффициент уменьшения изображения при иерархической обработке. На последнем этапе пользователь может редактировать канал прозрачности следующими инструментами мягкие кисти, контрастность, размытие, смазывание. После мазка одним из этих инструментов вызывается байесовский алгоритм для обновления значений F, B при фиксированном. Пользователь также может изменять разметку и вызывать пересчет значений прозрачности в выбранной прямоугольной области. Пересчет вызывается и без изменения разметки при изменении степени гладкости. Таким образом, можно использовать разные параметры для различных частей изображения. Численное сравнение Данный метод использовался на 27 изображениях из тестовой базы 5, в которой для каждого изображения есть две тернарные разметки более точная и менее точная . Улучшенный алгоритм сравнивался с исходным алгоритмом байесового матирования 1. Результаты сравнения приведены в таблице. Из таблицы видно, что наибольшее улучшение достигается на наборе с менее точной разметкой. В этом случае сложнее найти границу объекта, пользуясь только цветовой информацией, поэтому условие гладкости альфа-канала улучшает результат . Алгоритм матирования и интерактивный процесс реализованы авторами в программе GrowCut, которая является подключаемым модулем к программе Adobe Photoshop. В заключение отметим, что в данной статье предложен новый алгоритм интерактивного матирования изображений. Алгоритм основан на байесовом методе матирования, но с добавлением условия гладкости результирующего канала прозрачности. Интерактивная процедура матирования изображений упрощает и ускоряет процесс извлечения объекта переднего плана на изображении, комбинируя бинарную сегментацию и мягкое матирование со сглаживанием. 