РЕАЛИЗАЦИЯ СТЕРЕОРЕЖИМА ДЛЯ РАЗЛИЧНЫХ УСТРОЙСТВ ОТОБРАЖЕНИЯ В РЕАЛЬНОМ ВРЕМЕНИ 

В статье подробно рассматриваются алгоритмы реализации в реальном времени стереорежима в различных форматах, используемых в устройствах стереоотображения. В число рассмотренных систем и технологий стерео-отображения входят системы с анаглифическими, а также с затворными очками, поляризационные проекционные системы, мониторы с чересстрочной стереотехнологией и автостереоскопические мониторы Philips 3D Solutions.

 При создании виртуальной реальности актуальной задачей является моделирование объемного видения, то есть синтез изображения в стереорежиме. Как известно, объемное видение является важной особенностью визуального восприятия человеком окружающего пространства, связанной с бинокулярным устройством зрения. Для реализации стереорежима в системах виртуальной реальности могут применяться различные устройства стереоотображения, использующие кардинально различающиеся технологии разделения ракурсов для левого и правого глаза. В качестве примеров можно назвать анаглифические системы, использующие метод спектральной сепарации ракурсов системы, использующие поляризационную технологию системы с затворными очками мониторы с чересстрочной технологией автостереоскопические мониторы и т.д. Каждая из этих систем использует свой формат представления стереоизображения, так называемый стереоформат. Существующие системы виртуальной реальности, к сожалению, ориентированы на использование весьма ограниченного набора из наиболее распространенных форматов. Таким образом, актуальной является задача разработки новых методов синтеза изображений для широкого класса устройств стереоотображения в реальном режиме времени. Решение этой задачи позволяет не фиксироваться на одной из технологий стереоотображения и выбирать конкретное устройство отображения стерео из широкого класса исходя из стоимости, технологичности, удобства для определенного случая. Предлагаемые алгоритмы описывают реализацию стереорежима различных форматов в системе визуализации в реальном времени. Рассмотрим описание существующих систем и алгоритмы реализации стереорежима в различных форматах. Детали реализации приведены для графической библиотеки OpenGL и ориентированы на использование современных ускорителей трехмерной графики, поддерживающих так называемый язык шейдеров. Метод заключается в том, что цветовой спектр делится на две части одна отдается для левого ракурса, а другая для правого. Каждый ракурс пропускается через свой фильтр, который отделяет свою часть спектра. Итоговое изображение получается суммированием обработанных ракурсов. Последующее воспроизведение происходит с помощью очков с двумя разными фильтрами для разных глаз. При разделении ракурсов с помощью очков каждый глаз видит ракурс с урезанным спектром, однако человеческий мозг по мере возможности восстанавливает исходный цветовой спектр, и мы видим полноцветное изображение. Известно, что в среднем человеку требуется несколько минут на адаптацию, при этом после завершения просмотра продолжительное время сохраняется искаженное восприятие цветов. Существует несколько вариантов светофильтров, используемых для цветовой фильтрации. Наиболее распространен вариант красно-голубых фильтров, однако используются и желто-зеленые очки, а также очки со сложным спектром светопропускания. Рассмотрим алгоритм реализации стерео для наиболее распространенных и широко используемых красно-голубых очков. Цветовая фильтрация ракурса для левого глаза заключается в пропускании только красной составляющей цвета, а для правого глаза в пропускании синего и зеленого цветов. Алгоритм формирования стереоизображения в формате простого цветного анаглифа. 1. Очищаем экран . 2. 3. Формируем изображение сцены, соответствующее левому глазу. 4. Очищаем буфер глубины. 5. 6. Формируем изображение сцены, соответствующее правому глазу. Использование стандартного алгоритма, однако, обеспечивает посредственную цветопередачу. Многие цвета воспринимаются со значительными искажениями либо вовсе теряются, например, такие проблемы возникают для чистого красного и чистого голубого цветов. В 2 предложен метод цветовой фильтрации для распространенных красно-голубых очков, основанный на минимизации среднеквадратической ошибки в цветовом пространстве CIE стандартных LCD-мониторов. Пусть C цвет, соответствующий изображению для левого глаза C цвет, соответствующий изображению для правого глаза. Предлагается следующая формула смешивания Приведенную формулу можно достаточно легко реализовать с помощью визуализации в текстуру и небольшого фрагментного шейдера. Пусть изображение для левого глаза записывается в текстуру, привязываемую к текстурному блоку 0, а для правого глаза в текстуру, связываемую с текстурным блоком 1. В OpenGL на шейдерном языке ARB необходимый фрагментный шейдер выглядит следующим образом Результирующий алгоритм формирования стереоизображения в формате оптимизированного анаглифа будет следующим. Алгоритм формирования стереоизображения в формате оптимизированного анаглифа. 1. Формируем изображение сцены, соответствующее левому глазу, в текстуру 0. 2. Формируем изображение сцены, соответствующее правому глазу, в текстуру 1. 3. Формируем результирующее изображение с использованием приведенной выше шейдерной программы. Системы с затворными очками Подобные системы используют метод активной сепарации стереопары с помощью электронно-управляемых ЖК-шторок, которые попеременно перекрывают обзор для левого и правого глаза в те моменты, когда на экране появляются изображения для другого глаза. Преимуществами метода являются отсутствие цветовых искажений и достаточная степень сепарации стереопары. К недостаткам технологии можно отнести падение фактической частоты обновления кадров в 2 раза, что требует использования мониторов с очень высокой частотой обновления, а также относительную дороговизну активных очков, особенно их беспроводных вариантов, использующих радиоканал для передачи синхроимпульсов. Наиболее простым и распространенным способом построения стереоизображения для этих систем является использование так называемого квадробуфера. Вместо двух буферов вывода лицевого и заднего используются четыре задний левый, лицевой левый, задний правый и лицевой правый. Задача системы визуализации состоит только в том, чтобы сформировать в левом и правом задних буферах изображения для левого и правого глаза соответственно, а потом отправить команду на обновление лицевых буферов. Смена изображений правого и левого лицевых буферов на экране производится автоматически драйвером видеокарты, одновременно с этим мигают ЖКшторки на очках. Алгоритм выглядит следующим образом. Алгоритм формирования стереоизображения в формате квадробуфера. 1. Формируем изображение для левого глаза в левый задний буфер. 2. Формируем изображение для правого глаза в правый задний буфер. 3. Отправляем команду на обновление левого и правого лицевых буферов. Проекционные системы с линейной поляризацией Рассматриваемые системы используют технологии поляризационной сепарации стереопары. Изображения для левого и правого глаза поступают на проекторы, на которых установлены светофильтры, обладающие свойством линейной поляризации света. В результате их воздействия получаются световые волны с некоторым фиксированным углом поляризации. Фильтры на проекторах устанавливаются таким образом, что световые потоки имеют взаимно перпендикулярный угол поляризации. Световой поток проецируется на специальный экран, обладающий свойством сохранения поляризации отражаемого света или пропускаемого света . Далее световой поток поступает уже в глаза наблюдателя. Для сепарации изображений применяются поляризационные светофильтры, устанавливаемые в очки, имеющие тот же угол поляризации, что и светофильтры на проекторах. В итоге правый и левый глаз пользователя видят только ту часть изображения, которая им предназначена. Преимуществами проекционной поляризационной технологии являются отсутствие цветовых искажений, достаточно высокая степень разделения стереопары, возможность многопользовательского режима наблюдения при использовании больших экранов. Недостатки относительно высокая стоимость проекционного оборудования, необходимость тщательной юстировки проекторов, а также значительное ухудшение степени сепарации стереопары при вращении головы, что проявляется в эффекте двоения изображения. Рассматриваемые системы используют формат горизонтальной или вертикальной стереопары . Наиболее распространенный подход для построения изображений в данных форматах применение мультимониторных режимов horisontal span или vertical span или режима dual view . Реализация стереорежима в таком формате заключается в формировании в нужных областях рабочего стола изображений, соответствующих левому и правому глазу. Рассмотрим реализацию формата горизонтальной стереопары с использованием мультимониторного режима горизонтального расширения рабочего стола horisontal span. В этом режиме левая половина рабочего стола отправляется на проектор 1, а правая на проектор 2. Очевидно, что необходимо разделить окно визуализации ровно пополам и вывести в его левой и правой частях изображения с камер левого и правого глаза соответственно. При этом предполагается использование полноэкранного режима, в котором формируемое изображение занимает весь рабочий стол, в противном случае может не получиться правильное разделение изображений по выходам и будут возникать мешающие восприятию стерео посторонние участки рабочего стола. Поляризаторы Алгоритм формирования стереоизображения в формате горизонтальной стереопары. 1. Очищаем экран. 2. Находим размеры окна визуализации W, H. 3. Формируем изображение для левого глаза в левую половину окна вьюпорт . 4. Формируем изображение для правого глаза в правую половину окна вьюпорт . Мониторы с чересстрочной технологией стерео Чересстрочный формат организован таким образом, что в четных и нечетных строках попеременно записывается изображение для правого и левого глаза. Примером мониторов с чересстрочным форматом являются мониторы Zalman TriMon, JVC GD463D10E, Hyundai 3D и др. Для сепарации изображений стереопары в них используется технология круговой поляризации. На дисплей нанесена специальная пленка, преобразующая линейнополяризованный свет в свет с круговой поляризацией с разным направлением для четных и нечетных строк. Преимуществом рассматриваемых мониторов является достаточно хорошая степень разделения стереопары, которая не ухудшается при вращении головы благодаря технологии круговой поляризации. Недостатками же являются падение эффективного разрешения изображения в два раза, плохое качество отображения мелкого текста, а также малые углы наблюдения стереоэффекта в горизонтальной и вертикальной плоскостях . Алгоритм формирования изображения в чересстрочном формате следующий. На начальном этапе синтезируется изображение сцены для левого и правого глаза в нижнюю и верхнюю половины экрана соответственно . После этого содержимое окна копируется в текстуру. Затем прорисовываются прямоугольники размером в одну строку с текстурными координатами, соответствующими нужной строке полученной текстуры. Алгоритм формирования стереоизображения в чересстрочном формате. 1. Очищаем экран. 2. Находим размеры окна визуализации W, H. 3. 4. 5. Копируем содержимое экрана в текстуру. 6. Цикл по строкам экрана i от 0 до H2-1 . 6.1. 6.2. Издержки на копирование окна в текстуру могут быть полностью устранены с помощью технологии прямого рендеринга ракурсов в текстуру . Мониторы Philips 3D Solutions Подобные мониторы относятся к классу автостереоскопических, не требующих использования очков при просмотре стереоизображений. Сепарация ракурсов осуществляется с помощью системы вертикальных линз, которые обеспечивают разделение светового потока таким образом, что правый и левый глаз наблюдают только предназначенные для них изображения. Мониторы Philips 3D Solutions являются многоракурсными и позволяют наблюдать стереоэффект не только в фиксированной зоне напротив экрана, но и из нескольких фиксированных положений. В текущем поколении мониторов строится 9 ракурсов. Рассмотрим алгоритм реализации стереорежима для мониторов Philips 3D. Для получения правильного стереоэффекта необходимо сформировать изображение в специальном формате, поддерживаемом данным монитором. Этот формат также допускает дополнительную передачу изображения и карты глубины для фона. Это позволяет в некоторой степени сгладить проблему возникновения артефактов на границах объектов, возникающую вследствие недостаточности информации для построения изображения для областей, которые не видны в исходном изображении, но наблюдаются в смещенном ракурсе. При наличии дополнительной информации о фоне монитор использует ее для построения изображения за объектами. Однако отделение значимых объектов и объектов, относящихся к фону, является слабо формализуемой задачей и в общем случае не может быть автоматизировано. В данной реализации эта задача не рассматривается и используется базовый вариант стереоформата часть данных, относящихся к фону, не заполняется. Для активизации стереорежима и задания параметров стереоизображения мониторы Philips используют специальный заголовок, который интегрируется прямо в изображение в области левого верхнего угла. Монитор постоянно анализирует поступающее изображение и, встретив заголовок, считывает из него параметры стереоформата. Для записи заголовка используется специальное кодирование данных в пиксели цвета, которое практически исключает возможность случайного задания стереоформата в обычном изображении. При этом дополнительная информация, относящаяся к заголовку, максимально маскируется за счет особого ее распределения по некоторой области среди цветовой информации. То есть заголовок кодируется в старшем бите синего канала в пикселях верхней строки изображения. Информация, описывающая глубину, явным образом размещается в изображении и записывается в виде градаций серого цвета. Значение интенсивности таким образом кодируется восемью битами в диапазоне 0, 255. Значение 0 соответствует максимально удаленным объектам, которые монитор может воспроизвести в стерео. Значение 128 соответствует объектам, которые при настройках по умолчанию будут восприниматься лежащими в плоскости экрана. Значение 255 кодирует области, максимально выходящие из экрана. Диапазон 0, 128 задает области за экраном, . Для перевода информации о реальной глубине объектов, которая доступна при 3D-визуализации, в данное представление требуется задать преобразование значения координаты Z пикселей в диапазон 0, 255. Для реализации такого преобразования существует множество вариантов. Рассмотрим подход, использованный в данной реализации. Он заключается в выделении некоторого диапазона глубины, представляющего наибольший интерес применительно к данной сцене. Этот диапазон задается вручную пользователем с помощью фиксации ближней и дальней плоскостей, ограничивающих интересующую область. Ближней плоскости ставится в соответствие значение 255, дальней 0. Объекты, располагающиеся в заданном диапазоне глубины, полностью используют диапазон симулируемой монитором глубины стереоэффекта. Для объектов, которые находятся ближе передней плоскости или за дальней плоскостью, стереоэффект не наблюдается. Это вынужденное решение, поскольку точность кодирования невысока и составляет всего 8 бит. Рассмотрим формулу преобразования значения координаты Z при визуализации и реализацию этого преобразования с помощью шейдерной обработки. Интересующее преобразование можно задать следующей формулой, осуществляющей линейное преобразование диапазона d, d к диапазону 0, 1 d d D d d, где d дальность точки в видовой системе координат d расстояние до ближней плоскости d расстояние до дальней плоскости. Рассмотренное преобразование можно реализовать различными способами. Значение координаты z в видовой системе координат может быть восстановлено из буфера глубины, который можно записать в текстуру прямо на этапе создания основного изображения. Такой подход позволяет отправлять сцену на визуализацию лишь один раз. Однако он имеет свои сложности, заключающиеся в потере точности, которая визуально проявляется в эффекте полосатости результирующего изображения. В предлагаемой реализации для формирования глубины в градациях серого используется отдельный проход рисования сцены. Требуемое преобразование координаты z в градации серого цвета осуществляется с помощью шейдерной обработки. Для этого в рамках графической библиотеки OpenGL используется расширение ARBFRAGMENTPROGRAM. Для получения оконных координат во фрагментной программе предусмотрена возможность доступа к фрагментным координатам с помощью конструкции fragment.position. В случае перспективного проецирования, а именно оно используется при синтезе стереоэффекта, проекционное преобразование имеет следующий вид x x m 0 0 0 y 0 m 0 0 y z 0 0 m m z 0 0 1 0 1 w, где вектор проекционных координат точки вектор видовых координат точки в системе координат наблюдателя. Таким образом, можно легко найти интересующую глубину фрагмента d в системе координат камеры с помощью формулы. Результирующий шейдер состоит лишь из двух операций и имеет следующий вид Входной параметр program.local0, содержащий коэффициенты k1 и k2, задается перед выполнением визуализации. Рассмотрим полный алгоритм формирования изображения для мониторов Philips 3D Solutions. Алгоритм формирования изображения в стереоформате WowVx. 1. Очищаем экран. 2. Находим размеры окна визуализации W, H. 3. Формируем обычное изображение сцены в левую верхнюю четверть экрана . 4. Формируем изображение глубины в градациях серого с помощью описанного шейдера в правую верхнюю четверть экрана. 5. Копируем верхнюю половину экрана в текстуру. 6. Цикл по строкам экрана i от 0 до H2-1. 6.1. 7. Записываем заголовок изображения поверх полученного изображения с помощью функций glRasterPos2i и glDrawPixels. Предложенные алгоритмы в полном объеме были реализованы и протестированы в рамках системы визуализации 4. Это позволяет использовать для демонстрации в стереорежиме широкий спектр устройств стереоотображения и моделировать практически любые виртуальные сцены в реальном режиме времени. Издержки приведенных алгоритмов минимальны. Было исследовано падение скорости визуализации при включении стереорежима для различных стереоформатов, усредненное для нескольких тестовых сцен и нескольких тестовых компьютеров. Набор тестовых сцен включал высокополигональную сцену c большим количеством треугольников, с малым объемом текстур и небольшой пространственной сложностью для ее визуализации требуется в первую очередь высокая производительность геометрического процессора низкополигональную сцену, но с большим количеством текстур, высокой пространственной сложностью и сложными эффектами требует в первую очередь высокой производительности пиксельного процессора сбалансированную сцену со средним количеством треугольников, текстур и эффектов дает сбалансированную нагрузку на геометрическую и пиксельную части графического конвейера. Результаты исследования представлены в таблице. Из них следует, что накладные расходы на моделирование стереорежима невелики и в среднем можно считать, что для моделирования стереорежима требуется удвоенная производительность видеоподсистемы по сравнению с обычным монорежимом. 