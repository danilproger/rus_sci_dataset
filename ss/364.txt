ТЕХНОЛОГИЯ СИНТЕЗА СТЕРЕОРОЛИКОВ ВЫСОКОГО РАЗРЕШЕНИЯ В СИСТЕМЕ ТРЕХМЕРНОЙ ВИЗУАЛИЗАЦИИ РЕАЛЬНОГО ВРЕМЕНИ 

Описывается технология синтеза видеофайлов высокого разрешения, позволяющая в рамках системы визуализации реального времени получать видеоролики высокого качества в различных стереоформатах. Поддерживаются такие стереоформаты, как анаглифический, чересстрочный, форматы вертикальной и горизонтальной стереопары и формат для автостереоскопических мониторов Philips. Предложенная технология позволяет фиксировать в реальном режиме времени процесс тренировки, а затем синтезировать высококачественный видеоматериал, иллюстрирующий записанный процесс. Подробно рассмотрена соответствующая схема синтеза видеороликов на основе файлов записи тренировок, предложены соответствующие структуры данных и алгоритм их обработки. Отдельно рассмотрены этап записи видеороликов и связанные с ним вопросы синтеза изображения высокого разрешения в видеопамяти, устранения визуальных дефектов, обусловленных дискретностью изображения, вопросы сжатия видеоинформации и ее записи в файл. Программный модуль, разработанный на основе предложенных в статье технологий, может найти применение для решения широкого круга задач, где требуется синтез высококачественного видеоматериала, в том числе при построении имитационно-тренажерных комплексов, обучающих систем и игровых приложений..

 В последнее время все большее распространение получает оборудование для просмотра видео высокого разрешения High-definition video, НD video, в том числе ЖК телевизоры и плазменные панели бытового использования, становятся общедоступными 3D-технологии и оборудование для стереоотображения. На рынок поставляется большое количество различных моделей устройств, поддерживающих стереорежим. Таким образом, популярность данного оборудования обусловливает растущий спрос на технологии подготовки видеоматериалов высокого разрешения в различных стереоформатах. Источниками HD-видеоконтента могут быть записи реальных тренировочных, обучающих либо игровых процессов в имитационно-тренажерных комплексах, обучающих системах или игровых приложениях. Общим компонентом для таких систем является система трехмерной визуализации виртуальных сцен, которая обеспечивает синтез трехмерных изображений в режиме реального времени 1. В Центре визуализации и спутниковых информационных технологий НИИСИ РАН создана собственная система визуализации 2, обладающая широким спектром возможностей синтеза трехмерных виртуальных сцен, в том числе с использованием распределенных вычислений. Синтез трехмерных сцен в стереорежиме Для создания стереоэффекта используются несколько различных технологий, основанных на разных принципах разделения ракурсов для правого и левого глаза 3. Для разных устройств стереоотображения используются различные форматы представления видеоданных в стереорежиме. Рассмотрим особенности этих стереоформатов и соответствующие технологии синтеза сцены в системе визуализации. Более подробно алгоритмы реализации данных стереоформатов описаны в 4. Анаглифический формат стереоизображения предназначен для систем с анаглифическими очками, использующих метод спектральной сепарации стереопары. Этот метод заключается в том, что цветовой спектр делится на две части одна часть отдается для левого ракурса, а другая для правого. Каждый ракурс пропускается через свой фильтр, который отделяет собственную часть спектра. Итоговое изображение получается суммированием обработанных ракурсов. Последующее воспроизведение происходит с помощью очков с двумя разными фильтрами для правого и левого глаза. При разделении ракурсов с помощью очков каждый глаз видит ракурс с урезанным спектром, однако человеческий мозг по мере возможности восстанавливает исходный цветовой спектр, и мы видим полноцветное изображение. Наиболее распространен вариант красноголубых фильтров, также используются желто-зеленые очки и очки со сложным спектром светопропускания. Для реализации данного режима необходимо синтезировать на экране два ракурса, применив для каждого глаза свою цветовую фильтрацию. В случае использования красноголубых очков цветовая фильтрация ракурса для левого глаза заключается в пропускании только красной составляющей цвета, а для правого глаза синего и зеленого цветов. Еще одним широко распространенным форматом для представления данных в стереорежиме является формат горизонтальной или вертикальной стереопары . Изображения, соответствующие разным ракурсам, записываются в общее изображение, разделенное пополам либо по вертикали, либо по горизонтали. Реализация стереорежима в таком формате заключается в формировании в нужных областях окна изображений, соответствующих левому и правому глазу. Рассмотрим реализацию формата горизонтальной стереопары. В этом режиме левая половина изображения предназначена для левого глаза, а правая для правого. Очевидно, что необходимо разделить окно визуализации пополам и синтезировать в левой и правой его частях изображения с помощью виртуальных камер, соответствующих левому и правому глазу. Часть оборудования для стереоотображения использует чересстрочный формат . Он организован так, что в четных и нечетных строках попеременно записываются изображения для правого и левого глаза. Чересстрочный формат, наример, используют мониторы Zalman TriMon, JVC GD-463D10E, Hyundai 3D и другие. Для сепарации изображений стереопары в них применяется технология круговой поляризации. На дисплей нанесена специальная пленка, преобразующая линейно-поляризованный свет в свет с круговой поляризацией с разным направлением для четных и нечетных строк. Идея предлагаемого алгоритма формирования изображения в чересстрочном формате состоит в следующем. На начальном этапе синтезируется изображение сцены для левого и правого глаза в нижнюю и верхнюю половины экрана соответственно . После этого копируется содержимое буфера в текстуру. Затем рисуются прямоугольники размером в одну строку с текстурными координатами, соответствующими нужной строке полученной текстуры. В последнее время на рынке стереооборудования появились так называемые автостереоскопические мониторы, которые не требуют использования очков при просмотре стереоизображений. Сепарация ракурсов в них осуществляется с помощью системы вертикальных линз, которые обеспечивают разделение светового потока таким образом, что каждый глаз наблюдает только предназначенные для него изображения. Эти мониторы являются многоракурсными и позволяют наблюдать стереоэффект не только в фиксированной зоне напротив экрана, но и из нескольких фиксированных положений. Информация, описывающая глубину, явным образом размещается в изображении и записывается в виде градаций серого цвета. Значение интенсивности кодируется восемью битами в диапазоне 0, 255. Значение 0 соответствует максимально удаленным объектам, которые монитор может воспроизвести в стерео. Значение 128 соответствует объектам, которые при настройках по умолчанию будут восприниматься лежащими в плоскости экрана. Значение 255 кодирует области, максимально выходящие из экрана. Таким образом, диапазон 0, 128 задает области за экраном, а . Для перевода в данное представление информации о реальной глубине объектов, которая доступна при визуализации, требуется задать преобразование значения координаты Z пикселей в диапазон 0, 255. Для реализации такого преобразования существует множество вариантов. Рассмотрим один из них. Можно выделить некоторый диапазон глубины, представляющий наибольший интерес применительно к данной сцене. Этот диапазон задается вручную пользователем с помощью фиксации ближней и дальней плоскостей, ограничивающих интересующую область. Ближней плоскости ставится в соответствие значение 255, дальней значение 0. Объекты, располагающиеся в заданном диапазоне глубины, полностью используют диапазон симулируемой монитором глубины стереоэффекта. Рассмотренное преобразование реализуется с помощью синтеза сцены на отдельном проходе с помощью шейдерной обработки. Соответствующая шейдерная программа имеет минимальную вычислительную сложность. Рассмотрим общую технологию синтеза видеороликов в системе визуализации реального времени. Синтез видеороликов в системе визуализации реального времени Наиболее простой подход к синтезу видеороликов в системе трехмерной визуализации состоит в прямом захвате синтезированного изображения из буфера кадра и покадровой записи в видеофайл. Однако для обеспечения режима реального времени он в большинстве случаев не подходит. Процесс захвата кадра, его сжатие и запись имеют очень высокую вычислительную сложность и требуют сверхвысокопроизводительной дисковой подсистемы. Для записи несжатого HD-файла с разрешением 1920 1080 и скоростью воспроизведения 24 кадра в секунду требуется производительность дисковой подсистемы в 142 Мбс. Для записи сжатого видео требуется меньшая дисковая производительность, особенно для современных форматов сжатия например, стандарта Н.264. Однако задача эффективного сжатия требует высоких вычислительных ресурсов и пока не может быть выполнена в реальном режиме времени. Для решения данной проблемы предлагается использовать другой подход записать в каждом кадре параметры виртуальной сцены, позволяющие полностью восстановить ее внешний вид, и затем по ним выполнить последующий синтез видео в отдельном процессе. При таком подходе требование реального времени на этапе синтеза видеоролика не выставляется, процесс может осуществляться без ущерба качеству и в произвольном разрешении, не привязанном к разрешению экрана, используемому на этапе записи тренировки. Диаграмма связей такого двухступенчатого подхода представлена на рисунке 5. Для решения задачи записи и последующего воспроизведения тренировок в систему визуализации добавляется дополнительный блок обработки тренировок 5. Рассмотрим схему его функционирования. Для записи процесса тренировки выбирается диапазон времени между кадрами записи . Для последующего синтеза видеоролика он должен совпадать с его желаемой скоростью . Если при моделировании используется тот же шаг времени, задача фиксации параметров сцены значительно упрощается необходимо лишь сохранить в файл результаты моделирования текущего шага. В противном случае моменты времени расчета динамики и записи состояния не совпадают. В результате возникает проблема вычисления значений параметров виртуальной сцены в момент записи. Для ее решения существуют по крайней мере два подхода. Первый заключается в выборе последнего рассчитанного значения параметра. Этот подход очень прост, однако имеет существенные недостатки записанная траектория движения объекта сцены может существенно отличаться от исходной, кроме этого, на графике записанного параметра могут наблюдаться рывки, отсутствующие в исходной траектории. Второй подход, который позволяет устранить эти проблемы, состоит в интерполяции значений параметров, рассчитанных в соседние моменты времени. Для этого могут применяться обычная линейная интерполяция, а также квадратичные функции или полиномы более высоких порядков. Для записи файла тренировки используется следующая структура данных. В начале файла записывается заголовок, содержащий общую информацию идентификатор rec-файла, позволяющий проверить соответствие файла нужному формату имена файлов всех трехмерных сцен, используемых в тренировке количество пакетов шаг записи в миллисекундах продолжительность тренировки в миллисекундах. Вслед за заголовком в файл записываются пакеты, описывающие параметры виртуальной сцены на соответствующих шагах записи. Каждый пакет имеет собственный заголовок, в котором записываются размер пакета и данные, описывающие параметры виртуальной сцены. Для записи этих данных используется так называемая чанковая структура. Под чанком понимается структура, имеющая заголовок и блок данных. Такая организация позволяет обеспечить расширение формата хранения с сохранением обратной совместимости его версий. Чанки с новыми идентификаторами, не известными предыдущей версии формата, будут просто пропускаться, не нарушая общее функционирование системы. В качестве примеров записываемых параметров виртуальной сцены можно привести следующие преобразование системы координат объекта, записываемое в виде совокупности вектора перемещения v, задающего преобразование сдвига, и кватерниона единичной длины q, задающего ориентацию объекта флаг сокрытияоткрытия объекта или источника света раствор камеры раствор прожектора интенсивность источника света. Процедура синтеза видеоролика из rec-файла состоит в последовательном чтении рассмотренных выше пакетов, соответствующих очередному кадру, и в восстановлении по ним состояний виртуальной сцены. Из таких снимков параметров виртуальной сцены блок записи видеоролика формирует результирующий видеофайл. Рассмотрим этот блок и используемые в нем технологии. Запись видеороликов высокого разрешения В предлагаемой технологии запись результирующего видеоролика осуществляется покадрово. Схема блока записи показана на рисунке 6. Рассмотрим подробнее основные этапы его работы. При визуализации в графическом ускорителе изображение синтезируется в буфере цвета, входящем в буфер кадра. Максимальные размеры буфера цвета ограничены разрешением экрана, что не позволяет синтезировать в нем изображения более высокого разрешения. Для решения этой задачи предлагается использовать внеэкранный рендеринг подход, при котором изображение синтезируется во внеэкранном буфере видеопамяти, максимальные размеры которого в несколько раз Тренировка Блок обработки тренировки Блок обработки тренировки Видеофайл Блок записи видеоролика Синтез видеоролика Расчет моделируемых параметров Синтез кадра Кадр экранной визуализации Rec-файл превышают размеры буфера кадра . Одной из распространенных технологий, позволяющих реализовать этот подход, является технология FrameBufferObject 6. В предлагаемой реализации в видеопамяти создается внеэкранный буфер кадра, к которому в качестве буфера цвета подключается созданная ранее текстура, имеющая размеры видеокадра. Для синтеза изображения в данный буфер перед визуализацией кадра он устанавливается в качестве целевого. Как уже было отмечено, визуальные артефакты, связанные с алиасингом, проявляются в виде ступенчатости изображения сцены, а при движении камеры в сценах с высокой детальностью геометрии и в виде мерцания мелких деталей на изображении сцены. Для решения этой проблемы в настоящее время используется полноэкранное сглаживание изображения . Большее количество субпикселей обеспечивает более высокое качество сглаживания. При синтезе изображения в буфере кадра MSAA выполняется автоматически драйвером видеокарты. В предлагаемой реализации с внеэкранным синтезом изображения MSAA выполняется при специальном копировании внеэкранного буфера кадра. Для этого изображение вначале синтезируется в буфере отображения MSAA, подключенном к дополнительному внеэкранному буферу кадра, а затем копируется с интерполяцией в текстуру, подключенную к основному внеэкранному буферу. При таком копировании драйвер видеокарты автоматически выполняет интерполяцию субпикселей буфера отображения в пиксели текстуры, формируя в результате сглаженное изображение. Для сжатия и записи синтезированного изображения в avi-файл предлагается использовать распространенное API Video For Windows . Перед записью видеоролика создается и открывается avi-файл, открывается входной несжатый видеопоток и привязывается к ранее открытому файлу. С помощью стандартного диалога пользователь выбирает необходимый видеокодек из списка всех установленных в операционной системе кодеков и настраивает его параметры. На основе выбранного кодека и данных о входном видеопотоке открывается сжатый выходной видеопоток, который будет записываться в avi-файл. При записи видеоролика растровое изображение высокого разрешения, синтезированное в видеопамяти, захватывается с помощью OpenGL в битовый массив в оперативной памяти и передается во входной видеопоток. Кадры входного потока сжимаются выбранным кодеком, передаются в выходной сжатый видеопоток и записываются в avi-файл. В конце записи видеоролика видеопотоки и avi-файл закрываются. При синтезе видеоролика в системе визуализации пользователю также необходимо иметь возможность просматривать на экране записываемые кадры например, для выбора момента начала или конца записи ролика. При предлагаемом внеэкранном методе синтеза видеоролика записываемые кадры визуализируются с помощью вписанного в экран прямоугольника с наложенной на него текстурой, содержащей синтезированное изображение виртуальной сцены. С учетом приведенного соотношения предлагается следующий алгоритм работы блока записи видеоролика высокого разрешения. 1. Создать и открыть avi-файл. 2. Открыть входной несжатый видеопоток V. 3. Выбрать формат сжатия С. 4. Открыть выходной видеопоток V со сжатием С. 5. Создать внеэкранный буфер кадра FBO с подключенной текстурой T. 6. Создать внеэкранный буфер кадра FBO с подключенным MSAA буфером отображения R. 7. Цикл по синтезируемым кадрам a установить буфер FBO в качестве цели рендеринга b визуализировать снимок параметров виртуальной сцены c копировать с интерполяцией буфер отображения R буфера FBO в текстуру T буфера FBO d захватить текстуру T в битовый массив в оперативной памяти e передать битовый массив во входной видеопоток V f установить экранный буфер кадра в качестве цели рендеринга g визуализировать прямоугольник, вписанный в экран, с наложенной текстурой T. Конец цикла. 8. Удалить внеэкранный буфер кадра FBO. 9. Удалить внеэкранный буфер кадра FBO. 10. Закрыть входной видеопоток V. 11. Закрыть выходной видеопоток V. 12. Закрыть avi-файл. В заключение необходимо отметить, что предложенные технологии в полном объеме были реализованы в системе визуализации 1. На рисунке 7 отображен диалог настройки, предоставляющий возможности по изменению размеров изображения, степени сглаживания, настройке видеокодека и стереорежима. Разработанный программный модуль позволяет синтезировать высококачественные монои стереовидеоролики формата avi с разрешением до 8192 8192 со сглаживанием по 16 субпикселям с использованием установленного в системе видеокодека. Поддерживается несколько стереоформатов, включая анаглифический, чересстрочный, формат вертикальной и горизонтальной стереопары и формат для автостереоскопических мониторов Philips. Программный модуль может найти применение для широкого круга задач, где требуется синтез высококачественного видеоматериала, в том числе при построении имитационно-тренажерных комплексов, обучающих систем и игровых приложений. В дальнейших исследованиях предполагается рассмотреть вопрос более эффективного сжатия файлов записей, а также поддержку дополнительных контейнеров хранения видеоданных . 